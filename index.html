<script>
const API_BASE = "https://amea-oglasi-api.belmins1617.workers.dev";
const KEY_STORAGE = "amea_admin_key";

const $ = id => document.getElementById(id);

function getKey(){
  return (localStorage.getItem(KEY_STORAGE) || "").trim();
}

function setKeyStatus(){
  const k = getKey();
  $("key").value = k;
  $("keyStatus").textContent = k ? `✅ Sačuvan (${k.length} znakova)` : "⚠️ Nije unesen";
}

function saveKey(){
  const k = $("key").value.trim();
  if(!k) { alert("Unesi ADMIN_KEY"); return; }
  localStorage.setItem(KEY_STORAGE, k);
  setKeyStatus();
}

function clearKey(){
  localStorage.removeItem(KEY_STORAGE);
  setKeyStatus();
}

async function load(){
  $("status").textContent = "Učitavam...";
  const res = await fetch(API_BASE + "/api/oglasi", { cache:"no-store" });
  const data = await res.json();
  const items = data.items || [];

  if(!items.length){
    $("list").innerHTML = `<div class="muted">Nema oglasa.</div>`;
    $("status").textContent = "";
    return;
  }

  $("list").innerHTML = items.map(o => `
    <div class="item">
      <div>
        <div><b>${o.naziv || ""}</b> <span class="muted">(${o.kategorija || ""})</span></div>
        <div class="muted">${o.cijena || ""}</div>
        <div class="muted" style="font-size:12px">id: ${o.id}</div>
      </div>
      <button class="btn-danger" onclick="del('${o.id}')">Obriši</button>
    </div>
  `).join("");

  $("status").textContent = "";
}

async function create(){
  const key = getKey();
  if(!key){ alert("Prvo sačuvaj ADMIN_KEY."); return; }

  const payload = {
    kategorija: $("kategorija").value,
    naziv: $("naziv").value.trim(),
    cijena: $("cijena").value.trim(),
    opis: $("opis").value.trim(),
    spec: $("spec").value.split("\n").map(s=>s.trim()).filter(Boolean),
    kontakt: {
      telefon: $("telefon").value.trim(),
      email: $("email").value.trim()
    },
    slike: []
  };

  if(!payload.naziv){ $("status").textContent = "Naziv je obavezan."; return; }

  $("status").textContent = "Objavljujem...";
  const res = await fetch(API_BASE + "/api/oglasi", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Admin-Key": key
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    const t = await res.text();
    $("status").textContent = "Greška: " + t;
    return;
  }

  $("naziv").value = "";
  $("cijena").value = "";
  $("opis").value = "";
  $("spec").value = "";
  $("status").textContent = "Objavljeno ✅";
  await load();
}

async function del(id){
  const key = getKey();
  if(!key){ alert("Nema ADMIN_KEY."); return; }

  $("status").textContent = "Brišem...";
  const res = await fetch(API_BASE + "/api/oglasi?id=" + encodeURIComponent(id), {
    method:"DELETE",
    headers:{ "X-Admin-Key": key }
  });

  if(!res.ok){
    const t = await res.text();
    $("status").textContent = "Greška: " + t;
    return;
  }

  $("status").textContent = "Obrisano ✅";
  await load();
}

setKeyStatus();
load();
</script>
