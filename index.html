<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin panel | AMEA Tech</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="admin-wrap">
  <h1>Admin panel – Oglasi</h1>

  <div class="admin-card">
    <div class="grid">
      <div class="grid-1">

        <div>
          <label>ADMIN KEY (samo ti)</label>
          <input id="key" placeholder="Unesi ADMIN_KEY" />
          <div class="row" style="justify-content:flex-start;gap:8px;margin-top:8px">
            <button type="button" onclick="saveKey()">Sačuvaj</button>
            <button type="button" class="btn-ghost" onclick="clearKey()">Obriši</button>
            <span id="keyStatus" class="muted"></span>
          </div>
        </div>

        <div>
          <label>Kategorija</label>
          <select id="kategorija">
            <option value="racunari">Računari</option>
            <option value="laptopi">Laptopi</option>
            <option value="monitori">Monitori</option>
            <option value="toneri">Toneri</option>
          </select>
        </div>

        <div>
          <label>Naziv</label>
          <input id="naziv" placeholder="npr. Gaming PC Ryzen 5..." />
        </div>

        <div>
          <label>Cijena</label>
          <input id="cijena" placeholder="npr. 1499 KM" />
        </div>

        <div>
          <label>Opis</label>
          <textarea id="opis" placeholder="Kratak opis..."></textarea>
        </div>

        <div>
          <label>Specifikacije (svaka u novi red)</label>
          <textarea id="spec" placeholder="Ryzen 5 5600&#10;16GB RAM&#10;1TB SSD"></textarea>
        </div>

        <div>
          <label>Telefon</label>
          <input id="telefon" placeholder="+387..." />
        </div>

        <div>
          <label>Email</label>
          <input id="email" placeholder="info@..." />
        </div>

        <div class="row">
          <button type="button" onclick="create()">Objavi oglas</button>
          <button type="button" class="btn-ghost" onclick="load()">Osvježi</button>
          <span id="status" class="muted"></span>
        </div>

      </div>

      <div>
        <h3>Postojeći oglasi</h3>
        <div id="list"></div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = "https://amea-oglasi-api.belmins1617.workers.dev";
const KEY_STORAGE = "amea_admin_key";

const $ = id => document.getElementById(id);

function getKey(){
  return localStorage.getItem(KEY_STORAGE) || "";
}

function setKeyStatus(){
  const k = getKey();
  $("key").value = k;
  $("keyStatus").textContent = k ? "✅ Sačuvan" : "⚠️ Nije unesen";
}

function saveKey(){
  const k = $("key").value.trim();
  if(!k) { alert("Unesi ADMIN_KEY"); return; }
  localStorage.setItem(KEY_STORAGE, k);
  setKeyStatus();
}

function clearKey(){
  localStorage.removeItem(KEY_STORAGE);
  setKeyStatus();
}

async function load(){
  $("status").textContent = "Učitavam...";
  const res = await fetch(API_BASE + "/api/oglasi", { cache:"no-store" });
  const data = await res.json();
  const items = data.items || [];

  if(!items.length){
    $("list").innerHTML = `<div class="muted">Nema oglasa.</div>`;
    $("status").textContent = "";
    return;
  }

  $("list").innerHTML = items.map(o => `
    <div class="item">
      <div>
        <div><b>${o.naziv || ""}</b> <span class="muted">(${o.kategorija || ""})</span></div>
        <div class="muted">${o.cijena || ""}</div>
        <div class="muted" style="font-size:12px">id: ${o.id}</div>
      </div>
      <button class="btn-danger" onclick="del('${o.id}')">Obriši</button>
    </div>
  `).join("");

  $("status").textContent = "";
}

async function create(){
  const key = getKey();
  if(!key){ alert("Prvo sačuvaj ADMIN_KEY."); return; }

  const payload = {
    kategorija: $("kategorija").value,
    naziv: $("naziv").value.trim(),
    cijena: $("cijena").value.trim(),
    opis: $("opis").value.trim(),
    spec: $("spec").value.split("\n").map(s=>s.trim()).filter(Boolean),
    kontakt: {
      telefon: $("telefon").value.trim(),
      email: $("email").value.trim()
    },
    slike: []
  };

  if(!payload.naziv){ $("status").textContent = "Naziv je obavezan."; return; }

  $("status").textContent = "Objavljujem...";
  const res = await fetch(API_BASE + "/api/oglasi", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Admin-Key": key
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    const t = await res.text();
    $("status").textContent = "Greška: " + t;
    return;
  }

  $("naziv").value = "";
  $("cijena").value = "";
  $("opis").value = "";
  $("spec").value = "";
  $("status").textContent = "Objavljeno ✅";
  await load();
}

async function del(id){
  const key = getKey();
  if(!key){ alert("Nema ADMIN_KEY."); return; }

  $("status").textContent = "Brišem...";
  const res = await fetch(API_BASE + "/api/oglasi?id=" + encodeURIComponent(id), {
    method:"DELETE",
    headers:{ "X-Admin-Key": key }
  });

  if(!res.ok){
    const t = await res.text();
    $("status").textContent = "Greška: " + t;
    return;
  }

  $("status").textContent = "Obrisano ✅";
  await load();
}

setKeyStatus();
load();
</script>

</body>
</html>
